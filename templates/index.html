<script>
/* ---------- utils ---------- */
function show(id){
  ['landing','uploader','selector','deck'].forEach(x=>document.getElementById(x).style.display='none');
  document.getElementById(id).style.display='block';
}
function refreshStrip(){
  fetch('/api/items').then(r=>r.json()).then(items=>{
    const strip=document.getElementById('strip');
    strip.innerHTML='';
    items.forEach(it=>{
      const wrap=document.createElement('div');
      wrap.className='thumb';
      wrap.innerHTML=`<img src="${it.thumb}">
                      <div class="del" onclick="deleteFile('${it.id}')">×</div>`;
      wrap.onclick=(e)=>{if(e.target.className!=='del')editCaption(it.id,it.caption);};
      strip.appendChild(wrap);
    });
  });
}
function editCaption(id,oldCap){
  const cap=prompt("Add / edit caption",oldCap);
  if(cap!==null){
    fetch('/api/caption/'+id,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({'caption':cap})});
    refreshStrip();
  }
}
async function deleteFile(id){
  if(!confirm('Delete this photo?')) return;
  await fetch('/api/delete/'+id,{method:'POST'});
  refreshStrip(); refreshULists();
}

/* ---------- LOADING ---------- */
function showSpinner(show=true){
  let sp=document.getElementById('spinner');
  if(!sp){
    sp=document.createElement('div');
    sp.id='spinner';
    sp.innerHTML='<div class="lds-ring"><div></div><div></div><div></div><div></div></div>';
    document.body.appendChild(sp);
  }
  sp.style.display=show?'flex':'none';
}

/* ---------- FIXED BULK UPLOAD ---------- */
async function doBulkUpload(ev){
  ev.preventDefault();
  const files=document.getElementById('bulkFiles').files;
  const caption=document.getElementById('bulkCaption').value;
  if(!files.length){alert('Pick photos');return;}

  showSpinner(true);
  const fd=new FormData();
  for(let i=0;i<files.length;i++) fd.append('photos',files[i]);   // ← no duplicates
  fd.append('caption',caption);
  await fetch('/bulk_upload',{method:'POST',body:fd});
  document.getElementById('bulkFiles').value='';
  document.getElementById('bulkCaption').value='';
  refreshStrip();
  showSpinner(false);
}

/* ---------- lists ---------- */
async function refreshULists(){
  const res=await fetch('/api/lists');
  const lists=await res.json();
  const ul=document.getElementById('ulUl');
  ul.innerHTML='';
  Object.entries(lists).forEach(([name,items])=>{
    const li=document.createElement('li');
    li.innerHTML=`<div class="listTitle">${name}</div>
                  <div class="miniStrip">
                    ${Object.keys(items).map(id=>`<img src="/static/thumbs/${id}">`).join('')}
                  </div>`;
    ul.appendChild(li);
  });
}
async function refreshSelLists(){
  const res=await fetch('/api/lists');
  const lists=await res.json();
  const div=document.getElementById('selLists');
  div.innerHTML='';
  Object.keys(lists).forEach(name=>{
    const btn=document.createElement('button');
    btn.textContent=`Edit ${name}`;
    btn.onclick=()=>openDeck(name);
    div.appendChild(btn);
  });
}
async function createList(){
  const name=document.getElementById('listName').value.trim();
  if(!name) return alert('Name required');
  await fetch(`/api/list/${name}`,{method:'POST'});
  document.getElementById('listName').value='';
  refreshSelLists();
}
let listName='', items=[], idx=0, myPicks={};
async function openDeck(name){
  listName=name;
  const res=await fetch('/api/items');
  items=(await res.json()).filter(it=>!myPicks[it.id]);
  idx=0;
  show('deck');
  document.getElementById('deckTitle').textContent=`My list : ${name}`;
  renderDeck();
}
function renderDeck(){
  if(idx>=items.length){
    document.getElementById('bigImg').src='';
    document.getElementById('bigCap').textContent='All done!';
    document.getElementById('bigComment').textContent='';
    return;
  }
  const it=items[idx];
  document.getElementById('bigImg').src='/static/photos/'+it.id;
  document.getElementById('bigCap').textContent=it.caption;
  document.getElementById('bigComment').textContent='comment from uploader: '+it.caption;
}
async function vote(choice){
  const comment=document.getElementById('comment').value;
  const it=items[idx];
  await fetch(`/api/list/${listName}/vote`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({item:it.id,choice,comment})
  });
  myPicks[it.id]=choice;
  idx++;
  renderDeck();
  renderMyPics();
}
function renderMyPics(){
  const box=document.getElementById('myPics');
  box.innerHTML='';
  items.filter(i=>myPicks[i.id]==='want').forEach(i=>{
    const img=document.createElement('img');
    img.src=i.thumb;
    box.appendChild(img);
  });
}
// init
refreshStrip();
refreshULists();
refreshSelLists();
</script>
