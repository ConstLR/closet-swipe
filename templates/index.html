<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Closet Select</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{--primary:#005f73;--secondary:#0a9396;--bg:#f1f5f9;--card:#ffffff;--text:#111827;--danger:#ef4444;--radius:12px;--shadow:0 4px 12px rgba(0,0,0,.08);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;}
body{margin:0;background:var(--bg);color:var(--text);}
h1,h2,h3{margin:0 0 .5em;color:var(--primary);}
h1{text-align:center;padding-top:20px;}
button{cursor:pointer;border:none;border-radius:var(--radius);padding:.75em 1.5em;font-size:15px;font-weight:600;}
input,textarea{width:100%;box-sizing:border-box;padding:.5em;border:1px solid #d1d5db;border-radius:var(--radius);margin-bottom:.5em;}
textarea{resize:vertical;min-height:60px;}
#landing{display:flex;justify-content:center;gap:40px;margin-top:40px;}
#landing button{background:var(--primary);color:#fff;padding:1.2em 2.4em;font-size:18px;}
#uploader,#selector,#deck{max-width:1100px;margin:auto;padding:20px;display:none;}
#dropZone{border:2px dashed var(--primary);padding:40px;text-align:center;border-radius:var(--radius);cursor:pointer;margin-bottom:1em;transition: background-color 0.2s ease;}
#dropZone.dragover{background:#e0f2fe;}
.photo-strip{display:flex;overflow-x:auto;gap:12px;padding:12px;min-height:120px;background:#e9ecef;border-radius:var(--radius);margin-bottom:1em;}
.photo-strip .thumb{flex:0 0 120px;position:relative;border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);}
.photo-strip img{width:120px;height:120px;object-fit:cover;display:block;}
.photo-strip .del{position:absolute;top:4px;right:4px;background:var(--danger);color:#fff;border-radius:50%;width:24px;height:24px;font-size:14px;line-height:24px;text-align:center;cursor:pointer;border:none;}
#uploadArea{background:var(--card);padding:1.5em;border-radius:var(--radius);box-shadow:var(--shadow);margin:20px 0;}
#uploadArea h3{margin-top:0;}
#uploadArea button{background:var(--primary);color:#fff;}
#uLists{background:var(--card);padding:1.5em;border-radius:var(--radius);box-shadow:var(--shadow);}
#uLists ul{list-style:none;padding:0;margin:0;}
#uLists li{margin-bottom:1em;padding-bottom:1em;border-bottom:1px solid #eee;}
#uLists li:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0;}
#uLists a{color:var(--primary);text-decoration:none;font-size:18px;}
#selector h2, #uploader h2{margin-bottom:1em;}
#newListForm{background:var(--card);padding:1.5em;border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:1.5em;display:flex;flex-wrap:wrap;gap:10px;align-items:center;}
#newListForm input{flex:1 1 200px;}
#newListForm button{background:var(--primary);color:#fff;}
#selLists{display:flex;flex-wrap:wrap;gap:15px;}
#selLists button{background:var(--secondary);color:#fff;}
#deck{display:none;}
#deckTitle{margin-bottom:1em;}
#deckFlex{display:flex;flex-wrap:wrap;gap:20px;align-items:flex-start;}
.bigCard{background:var(--card);padding:1em;border-radius:var(--radius);box-shadow:var(--shadow);flex:1 1 500px;text-align:center;}
.bigCard img{max-width:100%;max-height:60vh;border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:1em;}
.bigCard .caption{margin:.5em 0;font-weight:600;}
.deckControls{display:flex;justify-content:center;gap:20px;margin:1em 0;}
.deckControls button{flex:1 1 120px;}
.deckControls .want{background:#22c55e;color:#fff;}
.deckControls .dont{background:#ef4444;color:#fff;}
.myList{flex:1 1 250px;background:var(--card);padding:1em;border-radius:var(--radius);box-shadow:var(--shadow);max-width:300px;}
.myList h4{margin:0 0 .5em 0;}
.myList #myPics{display:flex;flex-wrap:wrap;gap:6px;}
.myList img{width:75px;height:75px;object-fit:cover;border-radius:6px;box-shadow:var(--shadow);}
#spinner{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:9999;}
.lds-ring{display:inline-block;position:relative;width:64px;height:64px;}
.lds-ring div{box-sizing:border-box;display:block;position:absolute;width:51px;height:51px;margin:6px;border:6px solid #fff;border-color:#fff transparent transparent transparent;border-radius:50%;animation:lds-ring 1.2s cubic-bezier(0.5,0,0.5,1) infinite;}
.lds-ring div:nth-child(1){animation-delay:-0.45s;}
.lds-ring div:nth-child(2){animation-delay:-0.3s;}
.lds-ring div:nth-child(3){animation-delay:-0.15s;}
@keyframes lds-ring{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
</style>
</head>
<body>

<h1>CLOSET SELECT</h1>

<div id="spinner"><div class="lds-ring"><div></div><div></div><div></div><div></div></div></div>

<div id="landing">
  <button data-target="uploader">UPLOADER'S MENU</button>
  <button data-target="selector">SELECTOR'S MENU</button>
</div>

<div id="uploader">
  <h2>UPLOADER'S MENU <button onclick="show('landing')" style="float: right; background: var(--secondary); color: #fff;">Back</button></h2>
  <div id="uploadArea">
    <h3>1. Select photos to upload</h3>
    <div class="photo-strip" id="previewStrip"></div>
    <form id="uploadForm">
      <div id="dropZone">Drag & drop photos here or <strong>click to browse</strong></div>
      <input type="file" id="fileInput" multiple style="display: none;">
      <h3>2. Add a caption (optional)</h3>
      <textarea id="uploadCaption" placeholder="This caption will be applied to all uploaded photos"></textarea>
      <h3>3. Upload</h3>
      <button type="submit">Upload Photos</button>
    </form>
  </div>
  <div id="uLists">
    <h3>All Selector Lists (View Only)</h3>
    <ul id="ulUl"></ul>
  </div>
</div>

<div id="selector">
  <h2>SELECTOR'S MENU <button onclick="show('landing')" style="float: right; background: var(--secondary); color: #fff;">Back</button></h2>
  <div id="newListForm">
    <input id="listNameInput" placeholder="Enter a new list name (e.g., 'Summer Outfits')">
    <button id="createListBtn">Create New List</button>
  </div>
  <h3>Existing Lists</h3>
  <div id="selLists"></div>
</div>

<div id="deck">
  <h2 id="deckTitle"></h2>
  <div id="deckFlex">
    <div class="bigCard">
      <img id="bigImg" src="" alt="Item to select">
      <div class="caption" id="bigCap"></div>
      <div class="deckControls">
        <button class="want">I want it</button>
        <button class="dont">I don't want it</button>
      </div>
      <textarea id="commentText" placeholder="Add an optional comment..."></textarea>
    </div>
    <div class="myList">
      <h4>My Selection ('Wants')</h4>
      <div id="myPics"></div>
    </div>
  </div>
</div>

<script>
// --- GLOBAL STATE ---
let filesToUpload = [];
let currentDeck = { listName: '', items: [], votedIds: new Set(), currentIndex: 0 };

// --- DOM ELEMENTS ---
const dom = {
    spinner: document.getElementById('spinner'),
    landing: document.getElementById('landing'),
    uploader: document.getElementById('uploader'),
    selector: document.getElementById('selector'),
    deck: document.getElementById('deck'),
    // Uploader
    previewStrip: document.getElementById('previewStrip'),
    dropZone: document.getElementById('dropZone'),
    fileInput: document.getElementById('fileInput'),
    uploadForm: document.getElementById('uploadForm'),
    uploadCaption: document.getElementById('uploadCaption'),
    uploaderLists: document.getElementById('ulUl'),
    // Selector
    listNameInput: document.getElementById('listNameInput'),
    createListBtn: document.getElementById('createListBtn'),
    selectorLists: document.getElementById('selLists'),
    // Deck
    deckTitle: document.getElementById('deckTitle'),
    bigImg: document.getElementById('bigImg'),
    bigCap: document.getElementById('bigCap'),
    commentText: document.getElementById('commentText'),
    myPics: document.getElementById('myPics'),
    deckControls: document.querySelector('.deckControls'),
};

// --- UTILS ---
const show = (id) => {
    ['landing', 'uploader', 'selector', 'deck'].forEach(x => dom[x].style.display = 'none');
    dom[id].style.display = 'block';
};
const showSpinner = (visible) => {
    dom.spinner.style.display = visible ? 'flex' : 'none';
};

// --- API HELPERS ---
const api = {
    get: (url) => fetch(url).then(r => r.json()),
    post: (url, data) => fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    }).then(r => r.json()),
};

// --- UPLOADER LOGIC ---
function setupUploader() {
    dom.dropZone.addEventListener('click', () => dom.fileInput.click());
    dom.fileInput.addEventListener('change', () => handleFileUpload(dom.fileInput.files));
    
    // Drag and drop event listeners
    dom.dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dom.dropZone.classList.add('dragover');
    });
    dom.dropZone.addEventListener('dragleave', () => {
        dom.dropZone.classList.remove('dragover');
    });
    dom.dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dom.dropZone.classList.remove('dragover');
        handleFileUpload(e.dataTransfer.files);
    });

    dom.uploadForm.addEventListener('submit', doUpload);

    dom.previewStrip.addEventListener('click', (e) => {
        if (e.target.classList.contains('del')) {
            const index = parseInt(e.target.dataset.index, 10);
            filesToUpload.splice(index, 1);
            renderPreviews();
        }
    });
}

function handleFileUpload(files) {
    filesToUpload.push(...Array.from(files));
    renderPreviews();
}

function renderPreviews() {
    dom.previewStrip.innerHTML = '';
    filesToUpload.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const wrap = document.createElement('div');
            wrap.className = 'thumb';
            wrap.innerHTML = `<img src="${e.target.result}"><button class="del" data-index="${index}">×</button>`;
            dom.previewStrip.appendChild(wrap);
        };
        reader.readAsDataURL(file);
    });
}

async function doUpload(e) {
    e.preventDefault();
    if (filesToUpload.length === 0) return alert('Please select photos to upload.');
    
    showSpinner(true);
    const fd = new FormData();
    filesToUpload.forEach(f => fd.append('photos', f));
    fd.append('caption', dom.uploadCaption.value);
    
    await fetch('/bulk_upload', { method: 'POST', body: fd });
    
    filesToUpload = [];
    renderPreviews();
    dom.uploadCaption.value = '';
    
    refreshAll();
    showSpinner(false);
}

// --- SELECTOR & LIST LOGIC ---
function setupSelector() {
    dom.createListBtn.addEventListener('click', createList);
}

async function refreshSelectorLists() {
    const lists = await api.get('/api/lists');
    dom.selectorLists.innerHTML = '';
    Object.keys(lists).forEach(name => {
        const btn = document.createElement('button');
        btn.textContent = `Vote on: ${name}`;
        btn.onclick = () => openDeck(name);
        dom.selectorLists.appendChild(btn);
    });
}

async function refreshUploaderLists() {
    const lists = await api.get('/api/lists');
    dom.uploaderLists.innerHTML = '';
    Object.keys(lists).forEach(name => {
        const li = document.createElement('li');
        li.innerHTML = `<a href="/list/${name}" target="_blank">${name}</a>`;
        dom.uploaderLists.appendChild(li);
    });
}

async function createList() {
    const name = dom.listNameInput.value.trim();
    if (!name) return alert('List name is required.');
    await api.post(`/api/list/${name}`);
    dom.listNameInput.value = '';
    refreshSelectorLists();
}

// --- DECK (VOTING) LOGIC ---
async function openDeck(name) {
    showSpinner(true);
    currentDeck.listName = name;
    
    const [allItems, allLists] = await Promise.all([api.get('/api/items'), api.get('/api/lists')]);
    const listVotes = allLists[name] || {};
    currentDeck.votedIds = new Set(Object.keys(listVotes));
    
    currentDeck.items = allItems.filter(item => !currentDeck.votedIds.has(item.id));
    currentDeck.currentIndex = 0;
    
    show('deck');
    dom.deckTitle.innerHTML = `Voting on: <strong>${name}</strong> <button onclick="show('selector')" style="float: right; background: var(--secondary); color: #fff;">Back to Lists</button>`;
    renderMyPicks();
    renderCurrentDeckCard();
    showSpinner(false);
}

function renderCurrentDeckCard() {
    if (currentDeck.currentIndex >= currentDeck.items.length) {
        dom.bigImg.src = '';
        dom.bigImg.style.display = 'none';
        dom.bigCap.textContent = '🎉 All items have been reviewed!';
        dom.deckControls.style.display = 'none';
        dom.commentText.style.display = 'none';
        return;
    }
    
    dom.bigImg.style.display = 'block';
    dom.deckControls.style.display = 'flex';
    dom.commentText.style.display = 'block';
    
    const item = currentDeck.items[currentDeck.currentIndex];
    dom.bigImg.src = `/static/photos/${item.id}`;
    dom.bigCap.textContent = item.caption || 'No caption';
    dom.commentText.value = '';
}

async function vote(choice) {
    const item = currentDeck.items[currentDeck.currentIndex];
    const comment = dom.commentText.value;
    
    await api.post(`/api/list/${currentDeck.listName}/vote`, {
        item: item.id,
        choice,
        comment
    });
    
    currentDeck.votedIds.add(item.id);
    if (choice === 'want') {
        renderMyPicks();
    }
    
    currentDeck.currentIndex++;
    renderCurrentDeckCard();
}

async function renderMyPicks() {
    const picks = await api.get(`/api/list/${currentDeck.listName}/items`);
    dom.myPics.innerHTML = '';
    picks
        .filter(p => p.choice === 'want')
        .forEach(p => {
            const img = document.createElement('img');
            img.src = p.thumb;
            img.title = p.caption;
            dom.myPics.appendChild(img);
        });
}

function setupDeck() {
    dom.deckControls.addEventListener('click', e => {
        if (e.target.classList.contains('want')) vote('want');
        if (e.target.classList.contains('dont')) vote('dont');
    });
}

// --- INITIALIZATION ---
function refreshAll() {
    refreshSelectorLists();
    refreshUploaderLists();
}

function initialize() {
    dom.landing.addEventListener('click', e => {
        if (e.target.tagName === 'BUTTON') {
            show(e.target.dataset.target);
        }
    });
    
    setupUploader();
    setupSelector();
    setupDeck();
    
    refreshAll();
    show('landing');
}

document.addEventListener('DOMContentLoaded', initialize);
</script>
</body>
</html>
