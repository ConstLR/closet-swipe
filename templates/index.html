<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Sélection Garde-Robe</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{--primary:#3a3a3a;--bg:#f3efe9;--card:#ffffff;--text:#3a3a3a;--border-color:#e0e0e0;--radius:8px;--danger:#d9534f;--success:#5cb85c;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;}
body{margin:0;padding:20px;background:var(--bg);color:var(--text);}
h1,h2,h3{margin:0 0 1em;color:var(--primary);text-transform:uppercase;letter-spacing:1px;text-align:center;}
button, input, select {font-family:inherit;font-size:15px;border:1px solid var(--border-color);border-radius:var(--radius);padding:.75em 1.5em;background:var(--card);box-sizing: border-box; width: 100%; margin-bottom: 10px;}
button{cursor:pointer;}
h2 { position: relative; }
.back-btn {position: absolute; top: -5px; left: 0; background: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 5px 15px; font-size: 14px; text-transform: none; letter-spacing: 0; width: auto;}
a.button-link {display: block; text-align: center; background: var(--primary); color: #fff; border: none; padding: 1.2em; font-size: 18px; text-transform: uppercase; letter-spacing: 1px; text-decoration: none; border-radius: var(--radius);}
select{padding:.75em; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%233a3a3a%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.4-5.4-13z%22/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right .7em top 50%; background-size: .65em auto; padding-right: 2.5em!important}
.page-container{max-width:1200px;margin:auto;padding:20px;display:none;}
.section-box{background:var(--card);padding:1.5em;border-radius:var(--radius);border:1px solid var(--border-color);margin-bottom:2em;}
.form-group{margin-bottom:1em;}
.form-group label{display:block;margin-bottom:.5em;font-weight:600;}
h1{font-size:1.2em;margin-bottom:2em;}
textarea{width:100%;box-sizing:border-box;padding:.5em;border:1px solid var(--border-color);border-radius:var(--radius);margin-bottom:.5em;resize:vertical;min-height:60px;font-family:inherit;}
#landing{text-align:center;max-width:600px;margin:40px auto; display:block;}
#landing .logo { margin-bottom: 2em; }
#landing .logo svg { width: 80px; height: 80px; color: var(--primary); }
#landing button{display:block;width:100%;text-align:center;margin-bottom:1em;background:var(--primary);color:#fff;border:none;padding:1.2em;font-size:18px;text-transform:uppercase;letter-spacing:1px;}
#dropZone{border:2px dashed var(--primary);padding:40px;text-align:center;border-radius:var(--radius);cursor:pointer;margin-bottom:1em;transition: background-color 0.2s ease;}
#dropZone.dragover{background:#e9e9e9;}
.photo-strip{display:flex;overflow-x:auto;gap:12px;padding:12px;min-height:120px;background:#f8f8f8;border:1px solid var(--border-color);border-radius:var(--radius);margin-bottom:1em;}
.photo-strip .thumb{flex:0 0 120px;position:relative;border-radius:var(--radius);overflow:hidden;}
.photo-strip img{width:120px;height:120px;object-fit:contain;background-color:#f0f0f0;}
.photo-strip .del{position:absolute;top:4px;right:4px;background:var(--danger);color:#fff;border-radius:50%;width:24px;height:24px;font-size:14px;line-height:24px;text-align:center;cursor:pointer;border:none;}
.list-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid var(--border-color); }
.list-item:last-child { border-bottom: none; }
.list-item span { flex-grow: 1; font-weight: 600; }
.delete-btn { width: auto; background-color: var(--danger); color: white; border: none; }
.edit-btn { width: auto; background-color: var(--primary); color: white; border: none; }
.vote-list-btn { width: auto; background-color: var(--success); color: white; border: none; }
#newListForm, #newCollectionForm {display:flex;flex-wrap:wrap;gap:10px;align-items:center;}
#newListForm input, #newCollectionForm input {flex:1 1 200px; background:#f8f8f8;}
#newListForm button, #newCollectionForm button { background: var(--primary); color:#fff; border:none; flex-shrink: 0; width: auto;}
#selLists, #collectionButtons {display:flex;flex-wrap:wrap;gap:15px;}
#deckFlex{display:flex;flex-wrap:wrap;gap:20px;align-items:flex-start;}
.bigCard{flex:1 1 500px;text-align:center;}
.bigCard img{width:100%;max-height:60vh;border-radius:var(--radius);border:1px solid var(--border-color);margin-bottom:1em;object-fit:contain;background-color:#f0f0f0;}
.bigCard .caption{margin:1em 0;font-weight:600;}
.deckControls{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:1em 0;}
.myList{flex:1 1 250px;background:var(--card);padding:1em;border:1px solid var(--border-color);border-radius:var(--radius);max-width:300px;}
.myList h4{text-align:left;margin:0 0 1em 0;}
.myList #myPics{display:flex;flex-wrap:wrap;gap:6px;}
.myList #myPics img { width:75px; height:75px; object-fit:contain; background-color:#f0f0f0; border-radius:6px; cursor:pointer; border: 2px solid transparent; }
.myList #myPics img.want { border-color: var(--success); }
.myList #myPics img.dont { border-color: var(--danger); opacity: 0.6; }
#spinner{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.35);display:none;align-items:center;justify-content:center;z-index:9999;}
.lds-ring{display:inline-block;position:relative;width:64px;height:64px;}
.lds-ring div{box-sizing:border-box;display:block;position:absolute;width:51px;height:51px;margin:6px;border:6px solid #fff;border-radius:50%;animation:lds-ring 1.2s cubic-bezier(0.5,0,0.5,1) infinite;border-color:#fff transparent transparent transparent;}
.lds-ring div:nth-child(1){animation-delay:-.45s}
.lds-ring div:nth-child(2){animation-delay:-.3s}
.lds-ring div:nth-child(3){animation-delay:-.15s}
@keyframes lds-ring{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
#toast-notification{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(120%);background:var(--primary);color:#fff;padding:15px 30px;border-radius:var(--radius);z-index:10000;opacity:0;visibility:hidden;transition:all .5s cubic-bezier(0.68, -0.55, 0.27, 1.55);}
#toast-notification.show{opacity:1;visibility:visible;transform:translateX(-50%) translateY(0);}
</style>
</head>
<body>

<div id="spinner"><div class="lds-ring"><div></div><div></div><div></div><div></div></div></div>
<div id="toast-notification"></div>

<div id="landing">
    <div class="logo">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21.61,4.28a1,1,0,0,0-1,.13L18,6.38V4a1,1,0,0,0-1-1H7A1,1,0,0,0,6,4V6.38L3.39,4.41a1,1,0,0,0-1.28,1.54L5,8.51V9a3,3,0,0,0,2,2.82V20a1,1,0,0,0,1,1h6a1,1,0,0,0,1-1V11.82A3,3,0,0,0,17,9V8.51l2.89-2.56A1,1,0,0,0,21.61,4.28ZM15,20H9V12.2a4.94,4.94,0,0,1,3-1,4.94,4.94,0,0,1,3,1ZM12,9a3,3,0,0,0-3-3H8.33L10,4h4l1.67,2H15A3,3,0,0,0,12,9Z"/></svg>
    </div>
    <h1>Sélection Garde-Robe</h1>
    <button data-target="uploader">Menu de l'Uploader</button>
    <button data-target="selector">Menu du Sélecteur</button>
    <a href="/selections" class="button-link">Voir les sélections</a>
</div>

<div id="uploader" class="page-container">
    <h2><button class="back-btn" data-target="landing">← Retour</button>Menu de l'Uploader</h2>
    <div class="section-box">
        <h3>Gérer les collections</h3>
        <div id="newCollectionForm">
            <input id="collectionNameInput" placeholder="Nom de la collection (ex: Robes d'été)">
            <button id="createCollectionBtn">Créer</button>
        </div>
        <div id="collectionsList" style="margin-top:1em;"></div>
    </div>
    <div class="section-box">
        <h3>Uploader de nouvelles photos</h3>
        <form id="uploadForm">
            <div class="form-group">
                <label for="collectionSelect">1. Choisissez une collection</label>
                <select id="collectionSelect" required></select>
            </div>
            <div class="form-group">
                <label>2. Sélectionnez les photos</label>
                <div class="photo-strip" id="previewStrip"></div>
                <div id="dropZone">Glissez-déposez les photos ici ou <strong>cliquez pour parcourir</strong></div>
                <input type="file" id="fileInput" multiple style="display: none;">
            </div>
            <div class="form-group">
                <label for="uploadCaption">3. Ajoutez une légende (optionnel)</label>
                <textarea id="uploadCaption" placeholder="Cette légende sera appliquée à toutes les photos."></textarea>
            </div>
            <button type="submit" style="background:var(--primary);color:#fff;">Uploader les photos</button>
        </form>
    </div>
</div>

<div id="selector" class="page-container">
    <h2><button class="back-btn" data-target="landing">← Retour</button>Menu du Sélecteur</h2>
    <div class="section-box">
        <h3>1. Gérez vos listes de sélection</h3>
        <div id="newListForm">
            <input id="listNameInput" placeholder="Entrez un nouveau nom de liste">
            <button id="createListBtn">Créer la liste</button>
        </div>
        <div id="selListsContainer" style="margin-top: 1em;"></div>
    </div>
    <div class="section-box" id="collectionSelectionBox" style="display:none;">
        <h3>2. Choisissez une collection pour voter</h3>
        <div id="collectionButtons"></div>
    </div>
</div>

<div id="deck" class="page-container">
    </div>

<div id="uploaderDeck" class="page-container">
    <h2 id="uploaderDeckTitle"></h2>
    <div class="bigCard" style="max-width: 700px; margin: auto;">
        <img id="uploaderDeckImg" src="" alt="Article à commenter">
        <div class="caption" id="uploaderDeckCap"></div>
        <textarea id="uploaderDeckComment" placeholder="Ajoutez ou modifiez la légende ici..."></textarea>
        <div class="deckControls">
            <button id="uploaderDeckPrev">← Précédent</button>
            <button id="uploaderDeckNext">Suivant →</button>
        </div>
        <button id="uploaderDeckSave" style="background:var(--success); color:#fff; width: 100%;">Enregistrer la légende</button>
    </div>
</div>


<script>
let filesToUpload = [];
let activeListName = '';
let currentDeck = { listName: '', collectionName: '', items: [], votedItems: new Map(), currentItem: null };
let uploaderDeck = { items: [], currentIndex: 0 };

const dom = {
    // ... (tous les éléments DOM de la version précédente)
    uploaderDeck: document.getElementById('uploaderDeck'),
    uploaderDeckTitle: document.getElementById('uploaderDeckTitle'),
    uploaderDeckImg: document.getElementById('uploaderDeckImg'),
    uploaderDeckCap: document.getElementById('uploaderDeckCap'),
    uploaderDeckComment: document.getElementById('uploaderDeckComment'),
    uploaderDeckPrev: document.getElementById('uploaderDeckPrev'),
    uploaderDeckNext: document.getElementById('uploaderDeckNext'),
    uploaderDeckSave: document.getElementById('uploaderDeckSave'),
};

// --- NOUVELLE FONCTION : Uploader Deck ---
async function openUploaderDeck(collectionName) {
    showSpinner(true);
    const items = await api.get(`/api/collections/${collectionName}/items`);
    uploaderDeck.items = items;
    uploaderDeck.currentIndex = 0;
    
    dom.uploaderDeckTitle.innerHTML = `<button class="back-btn" data-target="uploader">← Retour</button>Commenter la collection : <strong>${collectionName}</strong>`;
    show('uploaderDeck');
    renderUploaderDeckCard();
    showSpinner(false);
}

function renderUploaderDeckCard() {
    if (uploaderDeck.items.length === 0) {
        dom.uploaderDeckCap.textContent = "Cette collection est vide.";
        dom.uploaderDeckImg.style.display = 'none';
        return;
    }

    const item = uploaderDeck.items[uploaderDeck.currentIndex];
    dom.uploaderDeckImg.style.display = 'block';
    dom.uploaderDeckImg.src = `/static/photos/${item.id}`;
    dom.uploaderDeckCap.textContent = `Article ${uploaderDeck.currentIndex + 1} / ${uploaderDeck.items.length}`;
    dom.uploaderDeckComment.value = item.caption || '';
}

async function saveUploaderComment() {
    const item = uploaderDeck.items[uploaderDeck.currentIndex];
    const newCaption = dom.uploaderDeckComment.value;
    await api.post(`/api/caption/${item.id}`, { caption: newCaption });
    // Mettre à jour l'objet local pour ne pas avoir à recharger
    item.caption = newCaption;
    showToast('Légende enregistrée !');
}

// --- MODIFICATIONS DES FONCTIONS EXISTANTES ---
async function refreshCollectionsList() {
    const collections = await api.get('/api/collections');
    dom.collectionsList.innerHTML = '';
    collections.forEach(name => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'list-item';
        itemDiv.innerHTML = `
            <span>${name}</span>
            <button class="edit-btn" data-name="${name}">Commenter</button>
            <button class="delete-btn" data-type="collection" data-name="${name}">Supprimer</button>`;
        dom.collectionsList.appendChild(itemDiv);
    });
}


// --- INITIALISATION ---
function initialize() {
    // ... (Le reste de la fonction initialize, avec tous les event listeners)

    // Ajout des listeners pour le nouveau Uploader Deck
    dom.uploaderDeckPrev.addEventListener('click', () => {
        if (uploaderDeck.currentIndex > 0) {
            uploaderDeck.currentIndex--;
            renderUploaderDeckCard();
        }
    });
    dom.uploaderDeckNext.addEventListener('click', () => {
        if (uploaderDeck.currentIndex < uploaderDeck.items.length - 1) {
            uploaderDeck.currentIndex++;
            renderUploaderDeckCard();
        }
    });
    dom.uploaderDeckSave.addEventListener('click', saveUploaderComment);

    // Modifier le listener de body pour inclure le bouton "Commenter"
    document.body.addEventListener('click', async (e) => {
        // ... (logique des boutons back-btn et delete-btn)
        
        if (e.target.classList.contains('edit-btn')) {
            openUploaderDeck(e.target.dataset.name);
        }
    });
}
// ... (le reste du script complet doit être ici)
</script>
</body>
</html>
