<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Closet Select</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
/* Base styles from previous step remain the same */
:root{--primary:#3a3a3a;--bg:#f3efe9;--card:#ffffff;--text:#3a3a3a;--border-color:#e0e0e0;--radius:8px;--danger:#d9534f;--success:#5cb85c;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;}
body{margin:0;padding:20px;background:var(--bg);color:var(--text);}
h1,h2,h3{margin:0 0 1em;color:var(--primary);text-transform:uppercase;letter-spacing:1px;text-align:center;}
button, input, select {font-family:inherit;font-size:15px;border:1px solid var(--border-color);border-radius:var(--radius);padding:.75em 1.5em;background:var(--card);}
button{cursor:pointer;}
select{padding:.75em; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%233a3a3a%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.4-5.4-13z%22/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right .7em top 50%; background-size: .65em auto; padding-right: 2.5em!important}
.page-container{max-width:1200px;margin:auto;padding:20px;display:none;}
.section-box{background:var(--card);padding:1.5em;border-radius:var(--radius);border:1px solid var(--border-color);margin-bottom:2em;}
.form-group{margin-bottom:1em;}
.form-group label{display:block;margin-bottom:.5em;font-weight:600;}
#landing, #selLists { /* other styles */ }
/* Other base styles from previous step */
h1{font-size:1.2em;margin-bottom:2em;}
button{cursor:pointer;}
textarea{width:100%;box-sizing:border-box;padding:.5em;border:1px solid var(--border-color);border-radius:var(--radius);margin-bottom:.5em;resize:vertical;min-height:60px;font-family:inherit;}
#landing{text-align:center;max-width:600px;margin:40px auto;}
#landing .logo { margin-bottom: 2em; }
#landing .logo svg { width: 80px; height: 80px; color: var(--primary); }
#landing h1 { font-size: 1.2em; margin-bottom: 2em; }
#landing button{display:block;width:100%;text-align:center;margin-bottom:1em;background:var(--primary);color:#fff;border:none;padding:1.2em;font-size:18px;text-transform:uppercase;letter-spacing:1px;}
#dropZone{border:2px dashed var(--primary);padding:40px;text-align:center;border-radius:var(--radius);cursor:pointer;margin-bottom:1em;transition: background-color 0.2s ease;}
#dropZone.dragover{background:#e9e9e9;}
.photo-strip{display:flex;overflow-x:auto;gap:12px;padding:12px;min-height:120px;background:#f8f8f8;border:1px solid var(--border-color);border-radius:var(--radius);margin-bottom:1em;}
.photo-strip .thumb{flex:0 0 120px;position:relative;border-radius:var(--radius);overflow:hidden;}
.photo-strip img{width:120px;height:120px;object-fit:cover;display:block;}
.photo-strip .del{position:absolute;top:4px;right:4px;background:var(--danger);color:#fff;border-radius:50%;width:24px;height:24px;font-size:14px;line-height:24px;text-align:center;cursor:pointer;border:none;}
#uLists ul{list-style:none;padding:0;margin:0;}
#uLists li{padding: 1em; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;}
#uLists li:last-child{border-bottom:none;}
#uLists a{color:var(--primary);text-decoration:none;font-size:18px;font-weight:600;}
#newListForm, #newCollectionForm {display:flex;flex-wrap:wrap;gap:10px;align-items:center;}
#newListForm input, #newCollectionForm input {flex:1 1 200px; background:#f8f8f8;}
#newListForm button, #newCollectionForm button, #selLists button { background: var(--primary); color:#fff; border:none; }
#selLists{display:flex;flex-wrap:wrap;gap:15px;}
#deckFlex{display:flex;flex-wrap:wrap;gap:20px;align-items:flex-start;}
.bigCard{flex:1 1 500px;text-align:center;}
.bigCard img{max-width:100%;max-height:60vh;border-radius:var(--radius);border:1px solid var(--border-color);margin-bottom:1em;}
.bigCard .caption{margin:1em 0;font-weight:600;}
.deckControls{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:1em 0;}
.myList{flex:1 1 250px;background:var(--card);padding:1em;border:1px solid var(--border-color);border-radius:var(--radius);max-width:300px;}
.myList h4{text-align:left;margin:0 0 1em 0;}
.myList #myPics{display:flex;flex-wrap:wrap;gap:6px;}
.myList img{width:75px;height:75px;object-fit:cover;border-radius:6px;}
#spinner{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:9999;}
</style>
</head>
<body>

<div id="spinner"></div>

<div id="landing">
    </div>

<div id="uploader" class="page-container">
    <h2>UPLOADER'S MENU</h2>
    <div class="section-box">
        <h3>CREATE NEW COLLECTION</h3>
        <div id="newCollectionForm">
            <input id="collectionNameInput" placeholder="New collection name (e.g., 'Dresses')">
            <button id="createCollectionBtn">Create Collection</button>
        </div>
    </div>
    <div class="section-box">
        <h3>UPLOAD NEW PHOTOS</h3>
        <form id="uploadForm">
            <div class="form-group">
                <label for="collectionSelect">1. Choose Collection to Upload To</label>
                <select id="collectionSelect" required></select>
            </div>
            <div class="form-group">
                <label>2. Select Photos</label>
                <div class="photo-strip" id="previewStrip"></div>
                <div id="dropZone">Drag & drop photos here or <strong>click to browse</strong></div>
                <input type="file" id="fileInput" multiple style="display: none;">
            </div>
            <div class="form-group">
                <label for="uploadCaption">3. Add a caption (optional)</label>
                <textarea id="uploadCaption" placeholder="This caption will be applied to all uploaded photos"></textarea>
            </div>
            <button type="submit" style="background:var(--primary);color:#fff;">Upload Photos</button>
        </form>
    </div>
</div>

<div id="selector" class="page-container">
    <h2>SELECTOR'S MENU</h2>
    <div class="section-box">
        <h3>1. CREATE OR CHOOSE YOUR LIST</h3>
        <div id="newListForm">
            <input id="listNameInput" placeholder="Enter a new list name">
            <button id="createListBtn">Create New List</button>
        </div>
        <div id="selLists" style="margin-top: 1em;"></div>
    </div>
    <div class="section-box" id="collectionSelectionBox" style="display:none;">
        <h3>2. CHOOSE A COLLECTION TO VOTE ON</h3>
        <div id="collectionButtons"></div>
    </div>
</div>

<div id="deck" class="page-container">
    </div>

<script>
// --- GLOBAL STATE ---
let filesToUpload = [];
let activeListName = '';
let currentDeck = { listName: '', collectionName: '', items: [], votedIds: new Set(), currentIndex: 0 };

// --- DOM ELEMENTS (add new ones) ---
const dom = {
    // ... all previous DOM elements
    collectionNameInput: document.getElementById('collectionNameInput'),
    createCollectionBtn: document.getElementById('createCollectionBtn'),
    collectionSelect: document.getElementById('collectionSelect'),
    collectionSelectionBox: document.getElementById('collectionSelectionBox'),
    collectionButtons: document.getElementById('collectionButtons'),
    // ... rest of the DOM elements
};

// --- UTILS & API HELPERS (unchanged) ---

// --- NEW & MODIFIED FUNCTIONS ---

// Populates the dropdown in the Uploader menu
async function refreshCollectionsDropdown() {
    const collections = await api.get('/api/collections');
    dom.collectionSelect.innerHTML = '<option value="">-- Please select a collection --</option>';
    collections.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        dom.collectionSelect.appendChild(option);
    });
}

// Handles creation of a new collection
async function createCollection() {
    const name = dom.collectionNameInput.value.trim();
    if (!name) return alert('Collection name is required.');
    await api.post('/api/collections', { name });
    dom.collectionNameInput.value = '';
    refreshCollectionsDropdown(); // Refresh the dropdown after creating
}

// MODIFIED: Uploader's form submission
async function doUpload(e) {
    e.preventDefault();
    const collection = dom.collectionSelect.value;
    if (!collection) return alert('Please select a collection to upload to.');
    if (filesToUpload.length === 0) return alert('Please select photos to upload.');
    
    showSpinner(true);
    const fd = new FormData();
    fd.append('collection', collection); // Add collection to form data
    filesToUpload.forEach(f => fd.append('photos', f));
    fd.append('caption', dom.uploadCaption.value);
    
    await fetch('/bulk_upload', { method: 'POST', body: fd });
    
    filesToUpload = [];
    renderPreviews();
    dom.uploadCaption.value = '';
    showSpinner(false);
}

// MODIFIED: Selector chooses a list first, then a collection
async function setActiveList(listName) {
    activeListName = listName;
    // Highlight active list button (optional)
    document.querySelectorAll('#selLists button').forEach(btn => {
        btn.style.border = btn.textContent === listName ? '2px solid var(--success)' : '1px solid var(--border-color)';
    });
    
    // Now show collections
    const collections = await api.get('/api/collections');
    dom.collectionButtons.innerHTML = '';
    collections.forEach(name => {
        const btn = document.createElement('button');
        btn.textContent = name;
        btn.onclick = () => openDeck(activeListName, name); // Pass both list and collection name
        dom.collectionButtons.appendChild(btn);
    });
    dom.collectionSelectionBox.style.display = 'block';
}

// MODIFIED: Refresh selector lists to set the active list
async function refreshSelectorLists() {
    const lists = await api.get('/api/lists');
    dom.selectorLists.innerHTML = '';
    Object.keys(lists).forEach(name => {
        const btn = document.createElement('button');
        btn.textContent = name;
        btn.onclick = () => setActiveList(name); // Set this as the active list
        dom.selectorLists.appendChild(btn);
    });
}

// MODIFIED: `openDeck` now takes a collection name
async function openDeck(listName, collectionName) {
    showSpinner(true);
    currentDeck.listName = listName;
    currentDeck.collectionName = collectionName;
    
    // Fetch items for this specific collection
    const [collectionItems, allLists] = await Promise.all([
        api.get(`/api/collections/${collectionName}/items`),
        api.get('/api/lists')
    ]);
    
    const listVotes = allLists[listName] || {};
    currentDeck.votedIds = new Set(Object.keys(listVotes));
    
    // Filter out items that have already been voted on IN THIS LIST
    currentDeck.items = collectionItems.filter(item => !currentDeck.votedIds.has(item.id));
    currentDeck.currentIndex = 0;
    
    show('deck');
    dom.deckTitle.innerHTML = `Voting on <strong>${collectionName}</strong> for list: <strong>${listName}</strong>`;
    renderMyPicks();
    renderCurrentDeckCard();
    showSpinner(false);
}


// --- INITIALIZATION (add new event listeners) ---
function initialize() {
    // ... other initializers
    dom.createCollectionBtn.addEventListener('click', createCollection);
    
    // Refresh collections dropdown when uploader menu is shown
    const uploaderButton = document.querySelector('button[data-target="uploader"]');
    uploaderButton.addEventListener('click', refreshCollectionsDropdown);
    
    // ... rest of the initialize function from previous step
}

// Make sure to call initialize() on DOMContentLoaded
document.addEventListener('DOMContentLoaded', initialize);
</script>
</body>
</html>
