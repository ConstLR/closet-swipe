<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Closet Select</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{
  --primary:#005f73;
  --secondary:#0a9396;
  --bg:#f1f5f9;
  --card:#ffffff;
  --text:#111827;
  --danger:#ef4444;
  --radius:12px;
  --shadow:0 4px 12px rgba(0,0,0,.08);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
}
body{margin:0;background:var(--bg);color:var(--text);}
h1,h2,h3{margin:0 0 .5em;color:var(--primary);}
button{cursor:pointer;border:none;border-radius:var(--radius);padding:.75em 1.5em;font-size:15px;font-weight:600;}
input[type=file],textarea{padding:.5em;border:1px solid #d1d5db;border-radius:var(--radius);resize:vertical;}
#landing{display:flex;justify-content:center;gap:40px;margin-top:60px;}
#landing button{background:var(--primary);color:#fff;padding:1.2em 2.4em;font-size:18px;}
#uploader,#selector,#deck{max-width:1100px;margin:auto;padding:20px;display:none;}
.photo-strip{display:flex;overflow-x:auto;gap:12px;padding:10px 0;}
.photo-strip .thumb{flex:0 0 120px;position:relative;border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);}
.photo-strip img{width:120px;height:120px;object-fit:cover;}
.photo-strip .del{position:absolute;top:2px;right:2px;background:var(--danger);color:#fff;border-radius:50%;width:24px;height:24px;font-size:14px;line-height:24px;text-align:center;cursor:pointer;}
#uploadArea{background:var(--card);padding:1.5em;border-radius:var(--radius);box-shadow:var(--shadow);margin:20px 0;}
#uploadArea h3{margin-top:0;}
#uLists{background:var(--card);padding:1em;border-radius:var(--radius);box-shadow:var(--shadow);}
#uLists ul{list-style:none;padding:0;}
#uLists li{margin-bottom:1em;}
#uLists .listTitle{font-weight:700;margin-bottom:.4em;}
#uLists .miniStrip{display:flex;flex-wrap:wrap;gap:6px;}
#uLists .miniStrip img{height:60px;border-radius:6px;box-shadow:var(--shadow);}
#selector h2{margin-bottom:1em;}
#newListForm{background:var(--card);padding:1em;border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:1em;display:flex;gap:10px;align-items:center;}
#newListForm input{flex:1 1 200px;}
#selLists{display:flex;flex-wrap:wrap;gap:10px;}
#selLists button{background:var(--secondary);color:#fff;}
#deck{display:none;}
#deckTitle{margin-bottom:1em;}
#deckFlex{display:flex;flex-wrap:wrap;gap:20px;}
.bigCard{background:var(--card);padding:1em;border-radius:var(--radius);box-shadow:var(--shadow);flex:1 1 400px;text-align:center;}
.bigCard img{max-width:100%;max-height:60vh;border-radius:var(--radius);box-shadow:var(--shadow);}
.bigCard .caption{margin:.5em 0;font-weight:600;}
.bigCard .comment{font-style:italic;color:#555;}
.deckControls{display:flex;justify-content:center;gap:20px;margin:1em 0;}
.deckControls button{flex:1 1 120px;}
.deckControls .want{background:#22c55e;color:#fff;}
.deckControls .dont{background:#ef4444;color:#fff;}
.myList{flex:0 0 250px;background:var(--card);padding:1em;border-radius:var(--radius);box-shadow:var(--shadow);}
.myList img{width:60px;height:60px;object-fit:cover;margin:2px;border-radius:6px;}
</style>
</head>
<body>

<h1>CLOSET SELECT</h1>

<!-- Landing -->
<div id="landing">
    <button onclick="show('uploader')">UPLOADER'S MENU</button>
    <button onclick="show('selector')">SELECTOR'S MENU</button>
</div>

<!-- Uploader -->
<div id="uploader">
    <h2>UPLOADER'S MENU</h2>

    <!-- Recent photos -->
    <div class="photo-strip" id="strip"></div>

    <!-- Bulk upload -->
    <div id="uploadArea">
        <h3>Upload photos here</h3>
        <form onsubmit="doBulkUpload(event)">
            <input type="file" id="bulkFiles" multiple accept="image/*"><br>
            <textarea id="bulkCaption" placeholder="Optional caption for all"></textarea><br>
            <button>Upload</button>
        </form>
    </div>

    <!-- Lists -->
    <div id="uLists">
        <h3>All selectors' lists</h3>
        <ul id="ulUl"></ul>
    </div>
</div>

<!-- Selector -->
<div id="selector">
    <h2>SELECTOR'S MENU</h2>

    <div id="newListForm">
        <input id="listName" placeholder="List name">
        <button onclick="createList()">Create new list</button>
    </div>

    <div class="selLists" id="selLists"></div>
</div>

<!-- Deck -->
<div id="deck">
    <h3 id="deckTitle"></h3>
    <div id="deckFlex">
        <div class="bigCard">
            <img id="bigImg">
            <div class="caption" id="bigCap"></div>
            <div class="comment" id="bigComment"></div>
            <div class="deckControls">
                <button class="want" onclick="vote('want')">I want it</button>
                <button class="dont" onclick="vote('dont')">I don't want it</button>
            </div>
            <textarea id="comment" placeholder="Optional comment"></textarea>
        </div>
        <div class="myList">
            <h4>My selection</h4>
            <div id="myPics"></div>
        </div>
    </div>
</div>

<script>
// ---------- utils ----------
function show(id){
    ['landing','uploader','selector','deck'].forEach(x=>document.getElementById(x).style.display='none');
    document.getElementById(id).style.display='block';
}
function refreshStrip(){
    fetch('/api/items').then(r=>r.json()).then(items=>{
        const strip=document.getElementById('strip');
        strip.innerHTML='';
        items.forEach(it=>{
            const wrap=document.createElement('div');
            wrap.className='thumb';
            wrap.innerHTML=`<img src="${it.thumb}">
                            <div class="del" onclick="deleteFile('${it.id}')">Ã—</div>`;
            wrap.onclick=(e)=>{if(e.target.className!=='del')editCaption(it.id,it.caption);};
            strip.appendChild(wrap);
        });
    });
}
function editCaption(id,oldCap){
    const cap=prompt("Add / edit caption",oldCap);
    if(cap!==null){
        fetch('/api/caption/'+id,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({'caption':cap})});
        refreshStrip();
    }
}
async function deleteFile(id){
    if(!confirm('Delete this photo?')) return;
    await fetch('/api/delete/'+id,{method:'POST'});
    refreshStrip(); refreshULists();
}
async function doBulkUpload(ev){
    ev.preventDefault();
    const files=document.getElementById('bulkFiles').files;
    const caption=document.getElementById('bulkCaption').value;
    if(!files.length){alert('Pick photos');return;}
    const fd=new FormData();
    for(const f of files) fd.append('photos',f);
    fd.append('caption',caption);
    await fetch('/bulk_upload',{method:'POST',body:fd});
    document.getElementById('bulkFiles').value='';
    document.getElementById('bulkCaption').value='';
    refreshStrip();
}
// ---------- lists ----------
async function refreshULists(){
    const res=await fetch('/api/lists');
    const lists=await res.json();
    const ul=document.getElementById('ulUl');
    ul.innerHTML='';
    Object.entries(lists).forEach(([name,items])=>{
        const li=document.createElement('li');
        li.innerHTML=`<div class="listTitle">${name}</div>
                      <div class="miniStrip">
                        ${Object.keys(items).map(id=>`<img src="/static/thumbs/${id}">`).join('')}
                      </div>`;
        ul.appendChild(li);
    });
}
async function refreshSelLists(){
    const res=await fetch('/api/lists');
    const lists=await res.json();
    const div=document.getElementById('selLists');
    div.innerHTML='';
    Object.keys(lists).forEach(name=>{
        const btn=document.createElement('button');
        btn.textContent=`Edit ${name}`;
        btn.onclick=()=>openDeck(name);
        div.appendChild(btn);
    });
}
async function createList(){
    const name=document.getElementById('listName').value.trim();
    if(!name) return alert('Name required');
    await fetch(`/api/list/${name}`,{method:'POST'});
    document.getElementById('listName').value='';
    refreshSelLists();
}
let listName='', items=[], idx=0, myPicks={};
async function openDeck(name){
    listName=name;
    const res=await fetch('/api/items');
    items=(await res.json()).filter(it=>!myPicks[it.id]);
    idx=0;
    show('deck');
    document.getElementById('deckTitle').textContent=`My list : ${name}`;
    renderDeck();
}
function renderDeck(){
    if(idx>=items.length){
        document.getElementById('bigImg').src='';
        document.getElementById('bigCap').textContent='All done!';
        document.getElementById('bigComment').textContent='';
        return;
    }
    const it=items[idx];
    document.getElementById('bigImg').src='/static/photos/'+it.id;
    document.getElementById('bigCap').textContent=it.caption;
    document.getElementById('bigComment').textContent='comment from uploader: '+it.caption;
}
async function vote(choice){
    const comment=document.getElementById('comment').value;
    const it=items[idx];
    await fetch(`/api/list/${listName}/vote`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({item:it.id,choice,comment})
    });
    myPicks[it.id]=choice;
    idx++;
    renderDeck();
    renderMyPics();
}
function renderMyPics(){
    const box=document.getElementById('myPics');
    box.innerHTML='';
    items.filter(i=>myPicks[i.id]==='want').forEach(i=>{
        const img=document.createElement('img');
        img.src=i.thumb;
        box.appendChild(img);
    });
}
// init
refreshStrip();
refreshULists();
refreshSelLists();
</script>
</body>
</html>
