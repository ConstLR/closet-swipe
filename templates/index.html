<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Closet Select</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#fafafa;color:#333}
    h1{text-align:center;margin:20px 0 10px;font-size:28px}
    .menu{display:flex;justify-content:center;gap:40px;margin-bottom:20px}
    .menu button{padding:12px 24px;font-size:16px;border:none;border-radius:6px;cursor:pointer;background:#4caf50;color:#fff}
    .menu button:hover{opacity:.9}
    /* Uploader panel */
    #uploader{display:none;max-width:1000px;margin:auto;padding:0 10px}
    #uploader h2{margin:10px 0}
    .photo-strip{display:flex;overflow-x:auto;gap:10px;padding:10px 0}
    .photo-strip img{height:120px;border:1px solid #ccc;border-radius:4px;cursor:pointer}
    #uploadArea{margin:20px 0}
    #uploadArea input[type=file]{margin-bottom:6px}
    #uploadArea textarea{width:100%;max-width:400px;height:60px}
    #uploadArea button{margin-top:6px}
    #uLists ul{list-style:none;padding:0}
    #uLists li{padding:6px;border-bottom:1px solid #eee;cursor:pointer}
    /* Selector panel */
    #selector{display:none;max-width:1000px;margin:auto;padding:10px}
    .selLists{display:flex;gap:20px;flex-wrap:wrap;margin-bottom:20px}
    .selLists button{background:#2196f3;color:#fff;padding:8px 16px;border:none;border-radius:4px;cursor:pointer}
    #newListForm{margin-bottom:20px}
    #newListForm input{padding:8px;font-size:16px}
    #newListForm button{margin-left:6px}
    /* Selector deck */
    #deck{display:none}
    .bigCard{position:relative;text-align:center}
    .bigCard img{max-width:90%;max-height:60vh;border-radius:8px}
    .bigCard .caption{margin:10px 0;font-size:18px}
    .bigCard .uploaderComment{font-style:italic;color:#555;margin-bottom:10px}
    .deckControls{display:flex;justify-content:center;gap:40px;margin-top:20px}
    .deckControls button{padding:14px 28px;font-size:18px;border:none;border-radius:50px;cursor:pointer}
    .deckControls .want{background:#4caf50;color:#fff}
    .deckControls .dont{background:#f44336;color:#fff}
    #deck textarea{width:90%;max-width:400px;margin-top:10px}
    .myList{max-width:250px;margin-left:20px}
    .myList img{width:60px;height:60px;object-fit:cover;margin:2px;border:1px solid #ccc;border-radius:4px}
</style>
</head>
<body>

<h1>CLOSET SELECT</h1>

<!-- Landing -->
<div class="menu" id="landing">
    <button onclick="show('uploader')">Uploader's Menu</button>
    <button onclick="show('selector')">Selector's Menu</button>
</div>

<!-- Uploader -->
<div id="uploader">
    <h2>Uploader's Menu</h2>

    <!-- Recent photos -->
    <div class="photo-strip" id="strip"></div>

    <!-- Upload -->
    <div id="uploadArea">
        <input type="file" id="fileInput" accept="image/*">
        <br><textarea id="captionInput" placeholder="Optional caption"></textarea><br>
        <button onclick="doUpload()">Upload</button>
    </div>

    <!-- Lists -->
    <div id="uLists">
        <h3>All selectors' lists</h3>
        <ul id="ulUl"></ul>
    </div>
</div>

<!-- Selector -->
<div id="selector">
    <h2>Selector's Menu</h2>

    <!-- New / existing lists -->
    <div id="newListForm">
        <input id="listName" placeholder="New list name">
        <button onclick="createList()">Create new list</button>
    </div>

    <div class="selLists" id="selLists"></div>
</div>

<!-- Deck -->
<div id="deck">
    <h3 id="deckTitle"></h3>
    <div style="display:flex;justify-content:center">
        <div class="bigCard">
            <img id="bigImg"><br>
            <div id="bigCap"></div>
            <div id="bigUComment"></div>
            <div class="deckControls">
                <button class="want" onclick="vote('want')">I want it</button>
                <button class="dont" onclick="vote('dont')">I don't want it</button>
            </div>
            <textarea id="comment" placeholder="Optional comment"></textarea>
        </div>

        <!-- side preview -->
        <div class="myList">
            <h4>My list</h4>
            <div id="myPics"></div>
        </div>
    </div>
</div>

<script>
// ---------- util ----------
function show(id){
    ['landing','uploader','selector','deck'].forEach(x=>document.getElementById(x).style.display='none');
    document.getElementById(id).style.display='block';
}
// ---------- uploader ----------
async function refreshStrip(){
    const res = await fetch('/api/items');
    const items = await res.json();
    const strip=document.getElementById('strip');
    strip.innerHTML='';
    items.forEach(it=>{
        const img=document.createElement('img');
        img.src=it.thumb;
        img.onclick=()=>editCaption(it.id,it.caption);
        strip.appendChild(img);
    });
}
async function editCaption(id,oldCap){
    const cap=prompt("Edit caption",oldCap);
    if(cap!==null){
        await fetch('/api/caption/'+id,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({'caption':cap})});
        refreshStrip();
    }
}
async function doUpload(){
    const file=document.getElementById('fileInput').files[0];
    const cap=document.getElementById('captionInput').value;
    if(!file) return alert('Pick a photo');
    const fd=new FormData();
    fd.append('photo',file);
    fd.append('caption',cap);
    await fetch('/upload',{method:'POST',body:fd});
    document.getElementById('fileInput').value='';
    document.getElementById('captionInput').value='';
    refreshStrip();
}
async function refreshULists(){
    const res=await fetch('/api/lists');
    const lists=await res.json();
    const ul=document.getElementById('ulUl');
    ul.innerHTML='';
    Object.keys(lists).forEach(name=>{
        const li=document.createElement('li');
        li.textContent=name;
        li.onclick=()=>alert('List '+name+': '+Object.keys(lists[name]).length+' picks');
        ul.appendChild(li);
    });
}
// ---------- selector ----------
let listName='', items=[], idx=0, myPicks={};
async function refreshSelLists(){
    const res=await fetch('/api/lists');
    const lists=await res.json();
    const div=document.getElementById('selLists');
    div.innerHTML='';
    Object.keys(lists).forEach(name=>{
        const btn=document.createElement('button');
        btn.textContent='Edit '+name;
        btn.onclick=()=>openDeck(name);
        div.appendChild(btn);
    });
}
async function openDeck(name){
    listName=name;
    const res=await fetch('/api/items');
    items=(await res.json()).filter(it=>!myPicks[it.id]);
    idx=0;
    show('deck');
    document.getElementById('deckTitle').textContent='My list: '+name;
    renderDeck();
}
function renderDeck(){
    if(idx>=items.length){document.getElementById('bigImg').src='';document.getElementById('bigCap').textContent='All done!';return;}
    const it=items[idx];
    document.getElementById('bigImg').src='/static/photos/'+it.id;
    document.getElementById('bigCap').textContent=it.caption;
    document.getElementById('bigUComment').textContent='Uploader: '+it.caption;
}
async function vote(choice){
    const comment=document.getElementById('comment').value;
    const it=items[idx];
    await fetch(`/api/list/${listName}/vote`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({item:it.id,choice,comment})
    });
    myPicks[it.id]=choice;
    idx++;
    renderDeck();
    renderMyPics();
}
function renderMyPics(){
    const box=document.getElementById('myPics');
    box.innerHTML='';
    items.filter(i=>myPicks[i.id]==='want').forEach(i=>{
        const img=document.createElement('img');
        img.src=i.thumb;
        box.appendChild(img);
    });
}
async function createList(){
    const name=document.getElementById('listName').value.trim();
    if(!name) return alert('Name required');
    await fetch(`/api/list/${name}`,{method:'POST'});
    document.getElementById('listName').value='';
    refreshSelLists();
}
// init
refreshStrip();
refreshULists();
refreshSelLists();
</script>
</body>
</html>
