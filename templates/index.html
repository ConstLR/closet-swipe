<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Sélection Garde-Robe</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{--primary:#3a3a3a;--bg:#f3efe9;--card:#ffffff;--text:#3a3a3a;--border-color:#e0e0e0;--radius:8px;--danger:#d9534f;--success:#5cb85c;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;}
body{margin:0;padding:20px;background:var(--bg);color:var(--text);}
h1,h2,h3{margin:0 0 1em;color:var(--primary);text-transform:uppercase;letter-spacing:1px;text-align:center;}
button, input, select {font-family:inherit;font-size:15px;border:1px solid var(--border-color);border-radius:var(--radius);padding:.75em 1.5em;background:var(--card);box-sizing: border-box; width: 100%; margin-bottom: 10px;}
button{cursor:pointer;}
h2 { position: relative; }
.back-btn {position: absolute; top: -5px; left: 0; background: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 5px 15px; font-size: 14px; text-transform: none; letter-spacing: 0; width: auto;}
a.button-link {display: block; text-align: center; background: var(--primary); color: #fff; border: none; padding: 1.2em; font-size: 18px; text-transform: uppercase; letter-spacing: 1px; text-decoration: none; border-radius: var(--radius);}
select{padding:.75em; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%233a3a3a%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.4-5.4-13z%22/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right .7em top 50%; background-size: .65em auto; padding-right: 2.5em!important}
.page-container{max-width:1200px;margin:auto;padding:20px;display:none;}
.section-box{background:var(--card);padding:1.5em;border-radius:var(--radius);border:1px solid var(--border-color);margin-bottom:2em;}
.form-group{margin-bottom:1em;}
.form-group label{display:block;margin-bottom:.5em;font-weight:600;}
h1{font-size:1.2em;margin-bottom:2em;}
textarea{width:100%;box-sizing:border-box;padding:.5em;border:1px solid var(--border-color);border-radius:var(--radius);margin-bottom:.5em;resize:vertical;min-height:60px;font-family:inherit;}
#landing{text-align:center;max-width:600px;margin:40px auto; display:block;}
#landing .logo { margin-bottom: 2em; }
#landing .logo svg { width: 80px; height: 80px; color: var(--primary); }
#landing button{display:block;width:100%;text-align:center;margin-bottom:1em;background:var(--primary);color:#fff;border:none;padding:1.2em;font-size:18px;text-transform:uppercase;letter-spacing:1px;}
#dropZone{border:2px dashed var(--primary);padding:40px;text-align:center;border-radius:var(--radius);cursor:pointer;margin-bottom:1em;transition: background-color 0.2s ease;}
#dropZone.dragover{background:#e9e9e9;}
.photo-strip{display:flex;overflow-x:auto;gap:12px;padding:12px;min-height:120px;background:#f8f8f8;border:1px solid var(--border-color);border-radius:var(--radius);margin-bottom:1em;}
.photo-strip .thumb{flex:0 0 120px;position:relative;border-radius:var(--radius);overflow:hidden;}
.photo-strip img{width:120px;height:120px;object-fit:cover;display:block;}
.photo-strip .del{position:absolute;top:4px;right:4px;background:var(--danger);color:#fff;border-radius:50%;width:24px;height:24px;font-size:14px;line-height:24px;text-align:center;cursor:pointer;border:none;}
.list-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid var(--border-color); }
.list-item:last-child { border-bottom: none; }
.list-item span { flex-grow: 1; font-weight: 600; }
.delete-btn { width: auto; background-color: var(--danger); color: white; border: none; }
.vote-list-btn { width: auto; background-color: var(--success); color: white; border: none; }
#newListForm, #newCollectionForm {display:flex;flex-wrap:wrap;gap:10px;align-items:center;}
#newListForm input, #newCollectionForm input {flex:1 1 200px; background:#f8f8f8;}
#newListForm button, #newCollectionForm button { background: var(--primary); color:#fff; border:none; flex-shrink: 0; width: auto;}
#selLists, #collectionButtons {display:flex;flex-wrap:wrap;gap:15px;}
#deckFlex{display:flex;flex-wrap:wrap;gap:20px;align-items:flex-start;}
.bigCard{flex:1 1 500px;text-align:center;}
.bigCard img{max-width:100%;max-height:60vh;border-radius:var(--radius);border:1px solid var(--border-color);margin-bottom:1em;}
.bigCard .caption{margin:1em 0;font-weight:600;}
.deckControls{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:1em 0;}
.myList{flex:1 1 250px;background:var(--card);padding:1em;border:1px solid var(--border-color);border-radius:var(--radius);max-width:300px;}
.myList h4{text-align:left;margin:0 0 1em 0;}
.myList #myPics{display:flex;flex-wrap:wrap;gap:6px;}
.myList #myPics img { width:75px; height:75px; object-fit:cover; border-radius:6px; cursor:pointer; border: 2px solid transparent; }
.myList #myPics img.want { border-color: var(--success); }
.myList #myPics img.dont { border-color: var(--danger); opacity: 0.6; }
#spinner{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.35);display:none;align-items:center;justify-content:center;z-index:9999;}
.lds-ring{display:inline-block;position:relative;width:64px;height:64px;}
.lds-ring div{box-sizing:border-box;display:block;position:absolute;width:51px;height:51px;margin:6px;border:6px solid #fff;border-radius:50%;animation:lds-ring 1.2s cubic-bezier(0.5,0,0.5,1) infinite;border-color:#fff transparent transparent transparent;}
.lds-ring div:nth-child(1){animation-delay:-.45s}
.lds-ring div:nth-child(2){animation-delay:-.3s}
.lds-ring div:nth-child(3){animation-delay:-.15s}
@keyframes lds-ring{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
#toast-notification{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(120%);background:var(--primary);color:#fff;padding:15px 30px;border-radius:var(--radius);z-index:10000;opacity:0;visibility:hidden;transition:all .5s cubic-bezier(0.68, -0.55, 0.27, 1.55);}
#toast-notification.show{opacity:1;visibility:visible;transform:translateX(-50%) translateY(0);}
</style>
</head>
<body>

<div id="spinner"><div class="lds-ring"><div></div><div></div><div></div><div></div></div></div>
<div id="toast-notification"></div>

<div id="landing">
    <div class="logo">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21.61,4.28a1,1,0,0,0-1,.13L18,6.38V4a1,1,0,0,0-1-1H7A1,1,0,0,0,6,4V6.38L3.39,4.41a1,1,0,0,0-1.28,1.54L5,8.51V9a3,3,0,0,0,2,2.82V20a1,1,0,0,0,1,1h6a1,1,0,0,0,1-1V11.82A3,3,0,0,0,17,9V8.51l2.89-2.56A1,1,0,0,0,21.61,4.28ZM15,20H9V12.2a4.94,4.94,0,0,1,3-1,4.94,4.94,0,0,1,3,1ZM12,9a3,3,0,0,0-3-3H8.33L10,4h4l1.67,2H15A3,3,0,0,0,12,9Z"/></svg>
    </div>
    <h1>Sélection Garde-Robe</h1>
    <button data-target="uploader">Menu de l'Uploader</button>
    <button data-target="selector">Menu du Sélecteur</button>
    <a href="/selections" class="button-link">Voir les sélections</a>
</div>

<div id="uploader" class="page-container">
    <h2><button class="back-btn" data-target="landing">← Retour</button>Menu de l'Uploader</h2>
    <div class="section-box">
        <h3>Gérer les collections</h3>
        <div id="newCollectionForm">
            <input id="collectionNameInput" placeholder="Nom de la collection (ex: Robes d'été)">
            <button id="createCollectionBtn">Créer</button>
        </div>
        <div id="collectionsList" style="margin-top:1em;"></div>
    </div>
    <div class="section-box">
        <h3>Uploader de nouvelles photos</h3>
        <form id="uploadForm">
            <div class="form-group">
                <label for="collectionSelect">1. Choisissez une collection</label>
                <select id="collectionSelect" required></select>
            </div>
            <div class="form-group">
                <label>2. Sélectionnez les photos</label>
                <div class="photo-strip" id="previewStrip"></div>
                <div id="dropZone">Glissez-déposez les photos ici ou <strong>cliquez pour parcourir</strong></div>
                <input type="file" id="fileInput" multiple style="display: none;">
            </div>
            <div class="form-group">
                <label for="uploadCaption">3. Ajoutez une légende (optionnel)</label>
                <textarea id="uploadCaption" placeholder="Cette légende sera appliquée à toutes les photos."></textarea>
            </div>
            <button type="submit" style="background:var(--primary);color:#fff;">Uploader les photos</button>
        </form>
    </div>
</div>

<div id="selector" class="page-container">
    <h2><button class="back-btn" data-target="landing">← Retour</button>Menu du Sélecteur</h2>
    <div class="section-box">
        <h3>1. Gérez vos listes de sélection</h3>
        <div id="newListForm">
            <input id="listNameInput" placeholder="Entrez un nouveau nom de liste">
            <button id="createListBtn">Créer la liste</button>
        </div>
        <div id="selListsContainer" style="margin-top: 1em;"></div>
    </div>
    <div class="section-box" id="collectionSelectionBox" style="display:none;">
        <h3>2. Choisissez une collection pour voter</h3>
        <div id="collectionButtons"></div>
    </div>
</div>

<div id="deck" class="page-container">
    <h2 id="deckTitle"></h2>
    <div id="deckFlex">
        <div class="bigCard">
            <div id="deckContent">
                <img id="bigImg" src="" alt="Article à sélectionner">
                <div class="caption" id="bigCap"></div>
                <textarea id="commentText" placeholder="Ajoutez un commentaire (optionnel)..."></textarea>
                <div class="deckControls">
                    <button class="want" style="background:var(--success); color:#fff;">Je le veux</button>
                    <button class="dont" style="background:var(--danger); color:#fff;">Je n'en veux pas</button>
                </div>
            </div>
            <div id="deckFinished" style="display:none; padding: 4em 1em;">
                <h3>🎉 Liste terminée !</h3>
                <p>Tous les articles de cette collection ont été examinés.</p>
                <button class="back-btn" data-target="selector" style="position:static; margin-top:2em; width:auto;">Retour au choix des collections</button>
            </div>
        </div>
        <div class="myList">
            <h4>Ma Sélection</h4>
            <div id="myPics"></div>
        </div>
    </div>
</div>

<script>
let filesToUpload = [];
let activeListName = '';
let currentDeck = { listName: '', collectionName: '', items: [], votedItems: new Map(), currentItem: null };

const dom = {
    spinner: document.getElementById('spinner'),
    toast: document.getElementById('toast-notification'),
    landing: document.getElementById('landing'),
    uploader: document.getElementById('uploader'),
    selector: document.getElementById('selector'),
    deck: document.getElementById('deck'),
    collectionNameInput: document.getElementById('collectionNameInput'),
    createCollectionBtn: document.getElementById('createCollectionBtn'),
    collectionsList: document.getElementById('collectionsList'),
    collectionSelect: document.getElementById('collectionSelect'),
    previewStrip: document.getElementById('previewStrip'),
    dropZone: document.getElementById('dropZone'),
    fileInput: document.getElementById('fileInput'),
    uploadForm: document.getElementById('uploadForm'),
    uploadCaption: document.getElementById('uploadCaption'),
    listNameInput: document.getElementById('listNameInput'),
    createListBtn: document.getElementById('createListBtn'),
    selListsContainer: document.getElementById('selListsContainer'),
    collectionSelectionBox: document.getElementById('collectionSelectionBox'),
    collectionButtons: document.getElementById('collectionButtons'),
    deckTitle: document.getElementById('deckTitle'),
    deckContent: document.getElementById('deckContent'),
    deckFinished: document.getElementById('deckFinished'),
    bigImg: document.getElementById('bigImg'),
    bigCap: document.getElementById('bigCap'),
    commentText: document.getElementById('commentText'),
    myPics: document.getElementById('myPics'),
    deckControls: document.querySelector('.deckControls'),
};

const show = (id) => {
    ['landing', 'uploader', 'selector', 'deck'].forEach(x => {
        const el = document.getElementById(x);
        if (el) el.style.display = 'none';
    });
    const targetEl = document.getElementById(id);
    if(targetEl) targetEl.style.display = 'block';
};
const showSpinner = (visible) => dom.spinner.style.display = visible ? 'flex' : 'none';
const showToast = (message) => {
    dom.toast.textContent = message;
    dom.toast.classList.add('show');
    setTimeout(() => {
        dom.toast.classList.remove('show');
    }, 5000);
};
const api = {
    get: (url) => fetch(url).then(r => r.ok ? r.json() : Promise.reject('Erreur réseau')),
    post: (url, data) => fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }).then(r => r.ok ? r.json() : Promise.reject('Erreur réseau')),
    delete: (url) => fetch(url, { method: 'DELETE' }).then(r => r.ok ? r.json() : Promise.reject('Erreur réseau')),
};

async function refreshAllUploader() {
    await refreshCollectionsDropdown();
    await refreshCollectionsList();
}
async function refreshCollectionsDropdown() {
    const collections = await api.get('/api/collections');
    dom.collectionSelect.innerHTML = '<option value="">-- Veuillez sélectionner une collection --</option>';
    collections.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        dom.collectionSelect.appendChild(option);
    });
}
async function refreshCollectionsList() {
    const collections = await api.get('/api/collections');
    dom.collectionsList.innerHTML = '';
    collections.forEach(name => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'list-item';
        itemDiv.innerHTML = `<span>${name}</span><button class="delete-btn" data-type="collection" data-name="${name}">Supprimer</button>`;
        dom.collectionsList.appendChild(itemDiv);
    });
}
async function createCollection() {
    const name = dom.collectionNameInput.value.trim();
    if (!name) return alert('Le nom de la collection est requis.');
    await api.post('/api/collections', { name });
    dom.collectionNameInput.value = '';
    showToast(`Collection "${name}" créée !`);
    refreshAllUploader();
}
function handleFileUpload(files) { filesToUpload.push(...Array.from(files)); renderPreviews(); }
function renderPreviews() {
    dom.previewStrip.innerHTML = '';
    filesToUpload.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const wrap = document.createElement('div');
            wrap.className = 'thumb';
            wrap.innerHTML = `<img src="${e.target.result}" alt="Prévisualisation"><button class="del" data-index="${index}">×</button>`;
            dom.previewStrip.appendChild(wrap);
        };
        reader.readAsDataURL(file);
    });
}
async function doUpload(e) {
    e.preventDefault();
    const collection = dom.collectionSelect.value;
    if (!collection) return alert('Veuillez sélectionner une collection.');
    if (filesToUpload.length === 0) return alert('Veuillez sélectionner des photos.');
    showSpinner(true);
    const fd = new FormData();
    fd.append('collection', collection);
    filesToUpload.forEach(f => fd.append('photos', f));
    fd.append('caption', dom.uploadCaption.value);
    await fetch('/bulk_upload', { method: 'POST', body: fd });
    filesToUpload = [];
    renderPreviews();
    dom.uploadCaption.value = '';
    showSpinner(false);
    showToast('Upload réussi !');
}
async function createList() {
    const name = dom.listNameInput.value.trim();
    if (!name) return alert('Le nom de la liste est requis.');
    await api.post(`/api/list/${name}`);
    dom.listNameInput.value = '';
    refreshSelectorLists();
}
async function refreshSelectorLists() {
    const lists = await api.get('/api/lists');
    dom.selListsContainer.innerHTML = '';
    Object.keys(lists).forEach(name => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'list-item';
        itemDiv.innerHTML = `<span>${name}</span>
            <button class="vote-list-btn" data-name="${name}">Voter</button>
            <button class="delete-btn" data-type="list" data-name="${name}">Supprimer</button>`;
        dom.selListsContainer.appendChild(itemDiv);
    });
}
async function setActiveList(listName) {
    activeListName = listName;
    document.querySelectorAll('.vote-list-btn').forEach(btn => {
        btn.style.border = btn.dataset.name === listName ? '2px solid var(--success)' : 'none';
    });
    const collections = await api.get('/api/collections');
    dom.collectionButtons.innerHTML = '';
    collections.forEach(name => {
        const btn = document.createElement('button');
        btn.textContent = name;
        btn.onclick = () => openDeck(activeListName, name);
        dom.collectionButtons.appendChild(btn);
    });
    dom.collectionSelectionBox.style.display = 'block';
}
async function openDeck(listName, collectionName) {
    showSpinner(true);
    currentDeck.listName = listName;
    currentDeck.collectionName = collectionName;
    
    const [collectionItems, allLists] = await Promise.all([
        api.get(`/api/collections/${collectionName}/items`),
        api.get('/api/lists')
    ]);
    const listVotes = allLists[listName] || {};
    currentDeck.items = collectionItems;
    currentDeck.votedItems = new Map();
    for (const itemId in listVotes) {
        if (collectionItems.some(item => item.id === itemId)) {
            currentDeck.votedItems.set(itemId, listVotes[itemId].choice);
        }
    }
    
    show('deck');
    dom.deckTitle.innerHTML = `<button class="back-btn" data-target="selector">← Retour</button>Vote pour <strong>${collectionName}</strong> (liste : <strong>${listName}</strong>)`;
    updateMyPicks();
    
    let firstUnvotedIndex = currentDeck.items.findIndex(item => !currentDeck.votedItems.has(item.id));
    renderCurrentDeckCard(firstUnvotedIndex);
    showSpinner(false);
}
function renderCurrentDeckCard(index) {
    if (index === -1) {
        dom.deckContent.style.display = 'none';
        dom.deckFinished.style.display = 'block';
        return;
    }
    dom.deckContent.style.display = 'block';
    dom.deckFinished.style.display = 'none';
    currentDeck.currentItem = currentDeck.items[index];
    dom.bigImg.src = `/static/photos/${currentDeck.currentItem.id}`;
    dom.bigCap.textContent = currentDeck.currentItem.caption || 'Sans légende';
    dom.commentText.value = '';
}
async function vote(choice) {
    if (!currentDeck.currentItem) return;
    const currentItemId = currentDeck.currentItem.id;
    currentDeck.votedItems.set(currentItemId, choice);
    
    await api.post(`/api/list/${currentDeck.listName}/vote`, {
        item: currentItemId,
        choice: choice,
        comment: dom.commentText.value
    });
    updateMyPicks();
    
    let nextIndex = currentDeck.items.findIndex(item => !currentDeck.votedItems.has(item.id));
    renderCurrentDeckCard(nextIndex);
}
function updateMyPicks() {
    dom.myPics.innerHTML = '';
    const itemsById = Object.fromEntries(currentDeck.items.map(item => [item.id, item]));
    currentDeck.votedItems.forEach((choice, itemId) => {
        const item = itemsById[itemId];
        if (!item) return; // Ne pas afficher si l'item n'est pas dans le deck actuel
        const img = document.createElement('img');
        img.src = item.thumb;
        img.className = choice;
        img.dataset.itemId = itemId;
        img.onclick = () => jumpToItem(itemId);
        dom.myPics.appendChild(img);
    });
}
function jumpToItem(itemId) {
    const itemIndex = currentDeck.items.findIndex(item => item.id === itemId);
    if (itemIndex > -1) {
        renderCurrentDeckCard(itemIndex);
    }
}
function initialize() {
    document.body.addEventListener('click', async (e) => {
        if (e.target.classList.contains('back-btn')) {
            show(e.target.dataset.target);
            if (e.target.dataset.target === 'selector') {
                dom.collectionSelectionBox.style.display = 'none';
                document.querySelectorAll('.vote-list-btn').forEach(btn => btn.style.border = 'none');
            }
        }
        if (e.target.classList.contains('delete-btn')) {
            const type = e.target.dataset.type;
            const name = e.target.dataset.name;
            const confirmMsg = `Êtes-vous sûr de vouloir supprimer ${type === 'collection' ? 'la collection' : 'la liste'} "${name}" ?\n${type === 'collection' ? 'ATTENTION : Toutes les photos de cette collection seront définitivement effacées.' : ''}`;
            if (confirm(confirmMsg)) {
                await api.delete(`/api/${type}s/${name}`);
                showToast(`${type === 'collection' ? 'Collection' : 'Liste'} supprimée.`);
                type === 'collection' ? refreshAllUploader() : refreshSelectorLists();
            }
        }
        if (e.target.classList.contains('vote-list-btn')) {
            setActiveList(e.target.dataset.name);
        }
    });

    dom.landing.addEventListener('click', e => {
        const targetElement = e.target.closest('button, a.button-link');
        if (!targetElement) return;
        if (targetElement.dataset.target) {
            const target = targetElement.dataset.target;
            show(target);
            if (target === 'uploader') refreshAllUploader();
            if (target === 'selector') refreshSelectorLists();
        }
    });

    dom.createCollectionBtn.addEventListener('click', createCollection);
    dom.createListBtn.addEventListener('click', createList);
    dom.dropZone.addEventListener('click', () => dom.fileInput.click());
    dom.fileInput.addEventListener('change', () => handleFileUpload(dom.fileInput.files));
    dom.dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dom.dropZone.classList.add('dragover'); });
    dom.dropZone.addEventListener('dragleave', () => { dom.dropZone.classList.remove('dragover'); });
    dom.dropZone.addEventListener('drop', (e) => { e.preventDefault(); dom.dropZone.classList.remove('dragover'); handleFileUpload(e.dataTransfer.files); });
    dom.uploadForm.addEventListener('submit', doUpload);
    
    dom.previewStrip.addEventListener('click', (e) => {
        if (e.target.classList.contains('del')) {
            const index = parseInt(e.target.dataset.index, 10);
            filesToUpload.splice(index, 1);
            renderPreviews();
        }
    });
    dom.deckControls.addEventListener('click', e => {
        if (e.target.classList.contains('want')) vote('want');
        if (e.target.classList.contains('dont')) vote('dont');
    });
}
document.addEventListener('DOMContentLoaded', initialize);
</script>
</body>
</html>
