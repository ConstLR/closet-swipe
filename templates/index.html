<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Closet Select</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{
    --primary: #3a3a3a; /* Dark charcoal */
    --bg: #f3efe9;      /* Light beige */
    --card: #ffffff;
    --text: #3a3a3a;
    --border-color: #e0e0e0;
    --radius: 8px;
    --danger: #d9534f;
    --success: #5cb85c;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
}
body{margin:0;padding:20px;background:var(--bg);color:var(--text);}
h1,h2,h3{margin:0 0 1em;color:var(--primary);text-transform:uppercase;letter-spacing:1px;text-align:center;}
button, input {
    font-family: inherit;
    font-size: 15px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    padding: .75em 1.5em;
    background: var(--card);
}
button { cursor:pointer; }
textarea{width:100%;box-sizing:border-box;padding:.5em;border:1px solid var(--border-color);border-radius:var(--radius);margin-bottom:.5em;resize:vertical;min-height:60px;font-family:inherit;}
#landing{text-align:center;max-width:600px;margin:40px auto;}
#landing .logo { margin-bottom: 2em; }
#landing .logo svg { width: 80px; height: 80px; color: var(--primary); }
#landing h1 { font-size: 1.2em; margin-bottom: 2em; }
#landing button{
    display:block; width:100%; text-align:center; margin-bottom:1em;
    background: var(--primary); color:#fff; border:none; padding: 1.2em;
    font-size: 18px; text-transform:uppercase; letter-spacing:1px;
}
.page-container { max-width:1200px; margin:auto; padding:20px; display:none; }
.section-box {
    background: var(--card);
    padding: 1.5em;
    border-radius: var(--radius);
    border: 1px solid var(--border-color);
    margin-bottom: 2em;
}
#dropZone{border:2px dashed var(--primary);padding:40px;text-align:center;border-radius:var(--radius);cursor:pointer;margin-bottom:1em;transition: background-color 0.2s ease;}
#dropZone.dragover{background:#e9e9e9;}
.photo-strip{display:flex;overflow-x:auto;gap:12px;padding:12px;min-height:120px;background:#f8f8f8;border:1px solid var(--border-color);border-radius:var(--radius);margin-bottom:1em;}
.photo-strip .thumb{flex:0 0 120px;position:relative;border-radius:var(--radius);overflow:hidden;}
.photo-strip img{width:120px;height:120px;object-fit:cover;display:block;}
.photo-strip .del{position:absolute;top:4px;right:4px;background:var(--danger);color:#fff;border-radius:50%;width:24px;height:24px;font-size:14px;line-height:24px;text-align:center;cursor:pointer;border:none;}
#uLists ul{list-style:none;padding:0;margin:0;}
#uLists li{padding: 1em; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;}
#uLists li:last-child{border-bottom:none;}
#uLists a{color:var(--primary);text-decoration:none;font-size:18px;font-weight:600;}
#newListForm{display:flex;flex-wrap:wrap;gap:10px;align-items:center;}
#newListForm input{flex:1 1 200px; background:#f8f8f8;}
#newListForm button, #selLists button { background: var(--primary); color:#fff; border:none; }
#selLists{display:flex;flex-wrap:wrap;gap:15px;}
#deckFlex{display:flex;flex-wrap:wrap;gap:20px;align-items:flex-start;}
.bigCard{flex:1 1 500px;text-align:center;}
.bigCard img{max-width:100%;max-height:60vh;border-radius:var(--radius);border:1px solid var(--border-color);margin-bottom:1em;}
.bigCard .caption{margin:1em 0;font-weight:600;}
.deckControls{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:1em 0;}
.myList{flex:1 1 250px;background:var(--card);padding:1em;border:1px solid var(--border-color);border-radius:var(--radius);max-width:300px;}
.myList h4{text-align:left;margin:0 0 1em 0;}
.myList #myPics{display:flex;flex-wrap:wrap;gap:6px;}
.myList img{width:75px;height:75px;object-fit:cover;border-radius:6px;}
#spinner{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:9999;}
</style>
</head>
<body>

<div id="spinner"></div>

<div id="landing">
    <div class="logo">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21.61,4.28a1,1,0,0,0-1,.13L18,6.38V4a1,1,0,0,0-1-1H7A1,1,0,0,0,6,4V6.38L3.39,4.41a1,1,0,0,0-1.28,1.54L5,8.51V9a3,3,0,0,0,2,2.82V20a1,1,0,0,0,1,1h6a1,1,0,0,0,1-1V11.82A3,3,0,0,0,17,9V8.51l2.89-2.56A1,1,0,0,0,21.61,4.28ZM15,20H9V12.2a4.94,4.94,0,0,1,3-1,4.94,4.94,0,0,1,3,1ZM12,9a3,3,0,0,0-3-3H8.33L10,4h4l1.67,2H15A3,3,0,0,0,12,9Z"/></svg>
    </div>
    <h1>CLOSET SELECT</h1>
    <button data-target="uploader">UPLOADER'S MENU</button>
    <button data-target="selector">SELECTOR'S MENU</button>
</div>

<div id="uploader" class="page-container">
    <h2>UPLOADER'S MENU</h2>
    <div class="section-box">
        <h3>UPLOAD NEW PHOTOS</h3>
        <div class="photo-strip" id="previewStrip"></div>
        <form id="uploadForm">
            <div id="dropZone">Drag & drop photos here or <strong>click to browse</strong></div>
            <input type="file" id="fileInput" multiple style="display: none;">
            <textarea id="uploadCaption" placeholder="Optional caption will be applied to all uploaded photos"></textarea>
            <button type="submit" style="background:var(--primary);color:#fff;">Upload Photos</button>
        </form>
    </div>
    <div class="section-box">
        <h3>VIEW SELECTOR LISTS</h3>
        <ul id="ulUl"></ul>
    </div>
</div>

<div id="selector" class="page-container">
    <h2>SELECTOR'S MENU</h2>
    <div class="section-box">
        <h3>CREATE NEW LIST</h3>
        <div id="newListForm">
            <input id="listNameInput" placeholder="Enter a new list name (e.g., 'Summer Outfits')">
            <button id="createListBtn">Create New List</button>
        </div>
    </div>
    <div class="section-box">
        <h3>EDIT EXISTING LISTS</h3>
        <div id="selLists"></div>
    </div>
</div>

<div id="deck" class="page-container">
    <h2 id="deckTitle"></h2>
    <div id="deckFlex">
        <div class="bigCard">
            <img id="bigImg" src="" alt="Item to select">
            <div class="caption" id="bigCap"></div>
            <textarea id="commentText" placeholder="Add an optional comment..."></textarea>
            <div class="deckControls">
                <button class="want" style="background:var(--success); color:#fff;">I want it</button>
                <button class="dont" style="background:var(--danger); color:#fff;">I don't want it</button>
            </div>
        </div>
        <div class="myList">
            <h4>My Selection ('Wants')</h4>
            <div id="myPics"></div>
        </div>
    </div>
</div>

<script>
// --- FULL SCRIPT FROM PREVIOUS STEP ---
// --- This remains the same as the last version, as the logic was already correct ---

// --- GLOBAL STATE ---
let filesToUpload = [];
let currentDeck = { listName: '', items: [], votedIds: new Set(), currentIndex: 0 };
// --- DOM ELEMENTS ---
const dom = {
    spinner: document.getElementById('spinner'),
    landing: document.getElementById('landing'),
    uploader: document.getElementById('uploader'),
    selector: document.getElementById('selector'),
    deck: document.getElementById('deck'),
    previewStrip: document.getElementById('previewStrip'),
    dropZone: document.getElementById('dropZone'),
    fileInput: document.getElementById('fileInput'),
    uploadForm: document.getElementById('uploadForm'),
    uploadCaption: document.getElementById('uploadCaption'),
    uploaderLists: document.getElementById('ulUl'),
    listNameInput: document.getElementById('listNameInput'),
    createListBtn: document.getElementById('createListBtn'),
    selectorLists: document.getElementById('selLists'),
    deckTitle: document.getElementById('deckTitle'),
    bigImg: document.getElementById('bigImg'),
    bigCap: document.getElementById('bigCap'),
    commentText: document.getElementById('commentText'),
    myPics: document.getElementById('myPics'),
    deckControls: document.querySelector('.deckControls'),
};
// --- UTILS ---
const show = (id) => {
    ['landing', 'uploader', 'selector', 'deck'].forEach(x => {
        const el = document.getElementById(x);
        if (el) el.style.display = 'none';
    });
    const targetEl = document.getElementById(id);
    if(targetEl) targetEl.style.display = 'block';
};
const showSpinner = (visible) => { dom.spinner.style.display = visible ? 'flex' : 'none'; };
// --- API HELPERS ---
const api = {
    get: (url) => fetch(url).then(r => r.json()),
    post: (url, data) => fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }).then(r => r.json()),
};
// --- UPLOADER LOGIC ---
function setupUploader() {
    dom.dropZone.addEventListener('click', () => dom.fileInput.click());
    dom.fileInput.addEventListener('change', () => handleFileUpload(dom.fileInput.files));
    dom.dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dom.dropZone.classList.add('dragover'); });
    dom.dropZone.addEventListener('dragleave', () => { dom.dropZone.classList.remove('dragover'); });
    dom.dropZone.addEventListener('drop', (e) => { e.preventDefault(); dom.dropZone.classList.remove('dragover'); handleFileUpload(e.dataTransfer.files); });
    dom.uploadForm.addEventListener('submit', doUpload);
    dom.previewStrip.addEventListener('click', (e) => {
        if (e.target.classList.contains('del')) {
            const index = parseInt(e.target.dataset.index, 10);
            filesToUpload.splice(index, 1);
            renderPreviews();
        }
    });
}
function handleFileUpload(files) { filesToUpload.push(...Array.from(files)); renderPreviews(); }
function renderPreviews() {
    dom.previewStrip.innerHTML = '';
    filesToUpload.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const wrap = document.createElement('div');
            wrap.className = 'thumb';
            wrap.innerHTML = `<img src="${e.target.result}"><button class="del" data-index="${index}">×</button>`;
            dom.previewStrip.appendChild(wrap);
        };
        reader.readAsDataURL(file);
    });
}
async function doUpload(e) {
    e.preventDefault();
    if (filesToUpload.length === 0) return alert('Please select photos to upload.');
    showSpinner(true);
    const fd = new FormData();
    filesToUpload.forEach(f => fd.append('photos', f));
    fd.append('caption', dom.uploadCaption.value);
    await fetch('/bulk_upload', { method: 'POST', body: fd });
    filesToUpload = [];
    renderPreviews();
    dom.uploadCaption.value = '';
    refreshAll();
    showSpinner(false);
}
// --- SELECTOR & LIST LOGIC ---
function setupSelector() { dom.createListBtn.addEventListener('click', createList); }
async function refreshSelectorLists() {
    const lists = await api.get('/api/lists');
    dom.selectorLists.innerHTML = '';
    Object.keys(lists).forEach(name => {
        const btn = document.createElement('button');
        btn.textContent = `${name}`;
        btn.onclick = () => openDeck(name);
        dom.selectorLists.appendChild(btn);
    });
}
async function refreshUploaderLists() {
    const lists = await api.get('/api/lists');
    dom.uploaderLists.innerHTML = '';
    Object.keys(lists).forEach(name => {
        const li = document.createElement('li');
        li.innerHTML = `<span>${name}</span><a href="/list/${name}" target="_blank">View Results</a>`;
        dom.uploaderLists.appendChild(li);
    });
}
async function createList() {
    const name = dom.listNameInput.value.trim();
    if (!name) return alert('List name is required.');
    await api.post(`/api/list/${name}`);
    dom.listNameInput.value = '';
    refreshSelectorLists();
}
// --- DECK (VOTING) LOGIC ---
async function openDeck(name) {
    showSpinner(true);
    currentDeck.listName = name;
    const [allItems, allLists] = await Promise.all([api.get('/api/items'), api.get('/api/lists')]);
    const listVotes = allLists[name] || {};
    currentDeck.votedIds = new Set(Object.keys(listVotes));
    currentDeck.items = allItems.filter(item => !currentDeck.votedIds.has(item.id));
    currentDeck.currentIndex = 0;
    show('deck');
    dom.deckTitle.innerHTML = `VOTING ON: <strong>${name}</strong>`;
    renderMyPicks();
    renderCurrentDeckCard();
    showSpinner(false);
}
function renderCurrentDeckCard() {
    if (currentDeck.currentIndex >= currentDeck.items.length) {
        dom.bigImg.src = '';
        dom.bigImg.style.display = 'none';
        dom.bigCap.textContent = '🎉 All items have been reviewed!';
        dom.deckControls.style.display = 'none';
        dom.commentText.style.display = 'none';
        return;
    }
    dom.bigImg.style.display = 'block';
    dom.deckControls.style.display = 'grid';
    dom.commentText.style.display = 'block';
    const item = currentDeck.items[currentDeck.currentIndex];
    dom.bigImg.src = `/static/photos/${item.id}`;
    dom.bigCap.textContent = item.caption || 'No caption';
    dom.commentText.value = '';
}
async function vote(choice) {
    const item = currentDeck.items[currentDeck.currentIndex];
    const comment = dom.commentText.value;
    await api.post(`/api/list/${currentDeck.listName}/vote`, { item: item.id, choice, comment });
    currentDeck.votedIds.add(item.id);
    if (choice === 'want') { renderMyPicks(); }
    currentDeck.currentIndex++;
    renderCurrentDeckCard();
}
async function renderMyPicks() {
    const picks = await api.get(`/api/list/${currentDeck.listName}/items`);
    dom.myPics.innerHTML = '';
    picks
        .filter(p => p.choice === 'want')
        .forEach(p => {
            const img = document.createElement('img');
            img.src = p.thumb;
            img.title = p.caption;
            dom.myPics.appendChild(img);
        });
}
function setupDeck() {
    dom.deckControls.addEventListener('click', e => {
        if (e.target.classList.contains('want')) vote('want');
        if (e.target.classList.contains('dont')) vote('dont');
    });
}
// --- INITIALIZATION ---
function refreshAll() { refreshSelectorLists(); refreshUploaderLists(); }
function initialize() {
    dom.landing.addEventListener('click', e => {
        if (e.target.tagName === 'BUTTON') { show(e.target.dataset.target); }
    });
    setupUploader();
    setupSelector();
    setupDeck();
    refreshAll();
    show('landing');
}
document.addEventListener('DOMContentLoaded', initialize);
</script>
</body>
</html>
